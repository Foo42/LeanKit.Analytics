@{
    Layout = "~/Views/Layouts/_Layout.cshtml";
}
@model LeanKit.ReleaseManager.Controllers.TicketViewModel

@if (string.IsNullOrWhiteSpace(Model.ExternalId))
{
    <h2>@Model.Title</h2>    
}
else
{
    <h2>@Model.ExternalId - @Model.Title</h2>    
}

<div class="right-hand-bar">
    <div class="right-hand-bar-section" id="ticket-activity-breakdown">
        <h3>Activity Breakdown</h3>
        <div>
            <div id="main-graph-holder"></div>
        </div>
        <ul class="activity-list">
            @foreach(var activity in Model.ActivityBreakdown.Activities)
            {
                <li class="waste-graph-activity @activity.ClassName" data-activity-class="@activity.ClassName">
                    <div class="legend-block"></div>
                    <span class="activity-name">@activity.Activity</span> - <span class="percent">@activity.FormattedPercent</span>%
                    <div class="activity-time-detail">@activity.TimeSummary</div>
                </li>
            }
        </ul>
    </div>
</div>

<div id="ticket-detail-summary">
    <div class="ticket-detail-summary-item">
        <h3>Status</h3>
        <div class="summary-current-text">
            <div class="summary-current-activity">Is currently @Model.CurrentStatus</div>
            @if (string.IsNullOrWhiteSpace(@Model.Started))
            {
                <div>Not started yet</div>
            }
            else
            {
                <div>Started @Model.Started</div>
            }
            @if (string.IsNullOrWhiteSpace(@Model.Finished))
            {
                <div>Not released yet</div>
            }
            else
            {
                <div>Released @Model.Finished</div>
            }
        </div>
    </div>
    <div class="ticket-detail-summary-item">
        <h3>Size</h3>
        <div class="ticket-summary-cycle-time-container">
            <span class="ticket-summary-cycle-time">?</span>
        </div>
    </div>
    <div class="ticket-detail-summary-item">
        <h3>Cycle Time</h3>
        <div class="ticket-summary-cycle-time-container">
            <span class="ticket-summary-cycle-time">6</span><span class="ticket-summary-cycle-time-units"> days</span>
        </div>
    </div>
</div>

@section JavaScript
{
<script type="text/javascript" src="/Assets/js/lib/d3.min.js"></script>
<script type="text/javascript">
    (function WasteGraph(element) {
        var width = 300,
            height = 300,
            radius = Math.min(width, height) / 2,
            data = $.map($('.waste-graph-activity'), function (item) {
                var activityElement = $(item);

                return {
                    className: activityElement.data('activityClass'),
                    activity: $('.activity-name', activityElement).text(),
                    percent: $('.percent', activityElement).text()
                };
            }),
            colors = {
                Developing: {
                    color: '#7FC9FF'
                },
                Testing: {
                    color: '#0094FF'
                },
                WaitingtoTest: {
                    color: '#FFC700'
                },
                WaitingtoRelease: {
                    color: '#C45200'
                },
                Blocked: {
                    color: '#C40000'
                }
            };

        var arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(radius - 70);

        var pie = d3.layout.pie()
            .sort(null)
            .value(function (d) { return d.percent; });

        var svg = d3.select("#main-graph-holder").append("svg")
            .attr("width", width)
            .attr("height", height)
          .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        $('.legend-block', element).css('background-color', function () {
            return colors[$(this).parent().data('activityClass')].color;
        });

        var g = svg.selectAll(".arc")
                  .data(pie(data))
                .enter().append("g")
                  .attr("class", "arc");

        g.append("path")
            .attr("d", arc)
            .style("fill", function (d) {
                return colors[d.data.className].color;
            });
    })($('#ticket-activity-breakdown'));
</script>
}
